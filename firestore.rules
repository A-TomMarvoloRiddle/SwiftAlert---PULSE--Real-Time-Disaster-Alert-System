/**
 * @fileoverview Firestore Security Rules for PULSE - Real-time Disaster Alert System.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model for user profiles and alerts, 
 * while allowing broader read access to disaster events and insights.  Write access is restricted 
 * based on ownership or, potentially, administrative roles (not yet implemented). Data shape is not strictly enforced in this prototype.
 *
 * Data Structure:
 * - /users/{userId}:  User profile data, accessible only by the user themselves.
 * - /users/{userId}/alerts/{alertId}: Alerts for a specific user, accessible only by that user.
 * - /disasterEvents/{disasterEventId}: Disaster event data, potentially publicly readable (or readable by service accounts). Write access is restricted.
 * - /disasterEvents/{disasterEventId}/insights/{insightId}: Insights related to disaster events, potentially publicly readable (or readable by service accounts). Write access is restricted.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect privacy.
 * - Alerts are stored as a subcollection of users, enforcing ownership.
 * - Disaster events are potentially world readable, insights are also potentially world readable but write access is restricted.
 *
 * Denormalization for Authorization:  Alert documents under /users/{userId}/alerts/{alertId} contain copies of relevant DisasterEvent data. This avoids requiring `get()` calls to the /disasterEvents collection in the security rules, improving performance and preventing rule evaluation errors.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     * @param {string} userId - The user ID to compare against.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(resource);
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile with matching userId.
     * @allow (get, update, delete) - Authenticated user accesses their own profile.
     * @deny (create) - Authenticated user tries to create a profile with a mismatched userId.
     * @deny (get, update, delete) - Authenticated user tries to access another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing of all users for privacy.
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for alerts within a user's profile.
     * @path /users/{userId}/alerts/{alertId}
     * @allow (create) - Authenticated user creates an alert under their own profile.
     * @allow (get, update, delete) - Authenticated user accesses/modifies alerts under their own profile.
     * @deny (create) - Authenticated user tries to create an alert under another user's profile.
     * @deny (get, update, delete) - Authenticated user tries to access/modify alerts under another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for disaster events.
     * @path /disasterEvents/{disasterEventId}
     * @allow (get, list) - Anyone can read disaster event data.
     * @deny (create, update, delete) - Only authorized users/services can modify disaster event data.
     * @principle Allows public read access but restricts write access.
     */
    match /disasterEvents/{disasterEventId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add role-based authorization.
      allow update: if false; // TODO: Add role-based authorization.
      allow delete: if false; // TODO: Add role-based authorization.
    }

    /**
     * @description Rules for AI-generated insights related to disaster events.
     * @path /disasterEvents/{disasterEventId}/insights/{insightId}
     * @allow (get, list) - Anyone can read AI-generated insights data.
     * @deny (create, update, delete) - Only authorized users/services can modify AI-generated insights data.
     * @principle Allows public read access but restricts write access.
     */
    match /disasterEvents/{disasterEventId}/insights/{insightId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add role-based authorization.
      allow update: if false; // TODO: Add role-based authorization.
      allow delete: if false; // TODO: Add role-based authorization.
    }
  }
}