/**
 * @fileOverview Firestore Security Rules for the PULSE disaster alert system.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and alerts, while allowing broader access to disaster event data.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, accessible only to the owning user.
 * - /users/{userId}/alerts/{alertId}: Alerts specific to a user, accessible only to that user.
 * - /disasterEvents/{disasterEventId}: Disaster event data, potentially accessible to service accounts or admin roles for seeding or broader access.
 * - /disasterEvents/{disasterEventId}/insights/{insightId}: Insights related to disaster events, implicitly secured by the disaster event's permissions.
 *
 * Key Security Decisions:
 * - User profiles and alerts are strictly owned and controlled by the authenticated user.
 * - Disaster events are secured to prevent unauthorized client-side writes, with potential for service account or admin access.
 * - Listing of all users is explicitly disallowed for privacy.
 * - The system utilizes path-based ownership for user data and relies on backend logic (e.g., Cloud Functions) to maintain data integrity across denormalized data.
 *
 * Denormalization for Authorization:
 * - Alert documents under /users/{userId}/alerts contain denormalized data from DisasterEvent documents to avoid costly `get()` calls and enable authorization based solely on the alert document and the user's ID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user ID matches the authenticated user's ID and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user creates their own profile with matching userId.
     * @allow (get, update, delete) Authenticated user accesses/modifies their own profile.
     * @deny (create) Authenticated user attempts to create a profile for another user.
     * @deny (get, update, delete) Authenticated user attempts to access/modify another user's profile.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for alerts under a user profile.
     * @path /users/{userId}/alerts/{alertId}
     * @allow (create) Authenticated user creates an alert under their profile.
     * @allow (get, update, delete) Authenticated user accesses/modifies their own alerts.
     * @deny (create) Authenticated user attempts to create an alert under another user's profile.
     * @deny (get, update, delete) Authenticated user attempts to access/modify alerts under another user's profile.
     * @principle Enforces document ownership for all operations on user alerts.
     */
    match /users/{userId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for disaster events.
     * @path /disasterEvents/{disasterEventId}
     * @allow (get, list) Public read access to disaster events.
     * @deny (create, update, delete) Prevents unauthorized modification of disaster events.
     * @principle Allows public read access but restricts write access to prevent unauthorized changes.
     */
    match /disasterEvents/{disasterEventId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add service account or admin role check if needed.
    }

    /**
     * @description Security rules for AI-generated insights related to disaster events.
     * @path /disasterEvents/{disasterEventId}/insights/{insightId}
     * @allow (get, list) Public read access to insights.
     * @deny (create, update, delete) Prevents unauthorized modification of insights.
     * @principle Inherits security from the parent disaster event; write access is restricted.
     */
    match /disasterEvents/{disasterEventId}/insights/{insightId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add service account or admin role check if needed.
    }
  }
}